import { createServer } from "http";
import open from 'open';

const SUCCESS_HTML = `<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Deployment triggered - Colyseus Cloud</title>
  </head>
  <body style="display:flex; align-items:center; justify-content: center; font-family: Arial; font-size: 1.2em;">
    <p>✓ You can close this window and go back to the terminal.</p>
  </body>
</html>`;

export function authenticate(endpoint, port = 25678) {
  const authURL = `${endpoint}/application/deploy`;
  console.log(`\nPlease select an application from your web browser:`);
  console.log(`→ ${authURL}\n`)
  open(authURL);

  return new Promise((resolve, reject) => {
    const app = createServer(function(req, res) {
      const applicationIdAndToken = req.url.substring(1, req.url.length).split(":");
      if (applicationIdAndToken.length !== 2) {
        res.writeHead(200, { 'Content-Type': 'text/html' });
        res.end("Invalid selection");
        return;
      }

      res.writeHead(200, { 'Content-Type': 'text/html' });
      res.end(SUCCESS_HTML , function() {
        resolve({ applicationId: applicationIdAndToken[0], token: applicationIdAndToken[1], });
        app.close();
      });

    });

    app.listen(25678);
  });
}
